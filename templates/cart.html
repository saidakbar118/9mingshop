<!DOCTYPE html>
<html lang="uz">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Savat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background-color: #f4f4f8;
      padding-bottom: 100px;
      color: #1a1a1a;
      position: relative;
      min-height: 100vh;
    }
    header {
      background-color: #160063;
      color: white;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px var(--shadow);
    }
    header h1 {
      font-size: 22px;
    }
    .cart-container {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .cart-item {
      background: white;
      padding: 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .cart-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      gap: 6px;
      text-align: center;
    }
    
    .info-left, .info-center, .info-right {
      flex: 1;
      min-width: 80px;
      text-align: center;
      position: relative;
    }
    
    .info-center::before,
    .info-right::before {
      content: "|";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-weight: normal;
    }

    .info-center {
      padding-left: 8px;
    }
    .info-right {
      padding-left: 8px;
    }
    
    .info-center {
      font-weight: 600;
      color: #160063;
    }
    
    .cart-actions {
      justify-content: center;
    }
    .cart-actions span {
      display: inline-block;
      width: 20px;
      text-align: center;
    }
    
    @media (max-width: 500px) {
      .cart-item img {
        display: none;
      }
    }
    .cart-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .info-left, .info-center, .info-right {
      font-size: 13px;
    }
    .cart-actions button {
      font-size: 14px;
      padding: 4px 8px;
    }
    .info-text h3 {
      font-size: 14px;
    }
    .info-text .price {
      font-weight: bold;
    }
    .cart-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cart-actions button {
      width: 28px; height: 28px;
      background-color: #160063;
      color: white; border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .summary-box {
      background: #fffcd5;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    .summary-box .left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .summary-box .right {
      text-align: right;
      color: #160063;
    }
    .summary-box .right div:first-child {
      font-size: 12px;
    }
    .summary-box .right div:last-child {
      font-size: 24px;
      font-weight: bold;
    }
    .payment-choice {
      background: white;
      padding: 12px;
      border-radius: 12px;
    }
    .payment-choice label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 14px;
    }
    .payment-choice .option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      padding: 0 16px;
    }
    .action-buttons button {
      width: 100%;
      padding: 12px;
      font-weight: 600;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: darkgreen;
      color: white;
      margin-top: 30px;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #160063;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 10;
    }
    footer a {
      text-align: center;
      font-size: 12px;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      transition: 0.2s ease;
    }
    footer a i {
      font-size: 22px;
      color: #ffffff;
    }
    footer a:hover,
    footer a:focus {
      color: #fff;
      transform: scale(1.05);
    }
    footer a:hover i {
      color: yellow;
    }
    .order-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 12px;
    }
    .modal-content h3 {
      margin-bottom: 16px;
      color: #160063;
    }
    .modal-content label {
      display: block;
      margin-top: 10px;
      font-size: 14px;
    }
    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .modal-buttons {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
    }
    .modal-buttons button {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      width: 137px;
    }
    .modal-buttons button:first-child {
      background: #ddd;
    }
    .modal-buttons button:last-child {
      background: darkgreen;
      color: white;
    }

    .address-group {
      position: relative;
    }
    
    .address-group textarea {
      width: 100%;
      padding: 8px 48px 8px 8px; /* o‘ng tomondan tugmaga joy qoldiramiz */
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
      height: 60px; /* balandligini oshirdik */
      font-size: 14px;
    }
    
    /* Kattaroq, yaqqol tugma */
    .address-group .map-button {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      background: gold;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      padding: 10px;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: 0.2s ease;
    }
    
    .address-group .map-button:hover {
      background: #b8860b;
    }
    
    .payment-options {
      display: flex;
      gap: 10px;
      margin: 10px 0 16px;
      flex-wrap: wrap;
    }
    
    .option-box {
      flex: 1;
      background-color: #f4f4f4;
      padding: 14px 12px;
      border-radius: 10px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
    }
    
    .option-box input[type="radio"] {
      display: none;
    }
    
    .option-box:has(input[type="radio"]:checked) {
      background-color: #160063;
      color: white;
      border-color: #160063;
    }

    .map-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }
    #map {
      width: 100%;
      max-width: 500px;
      height: 400px;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .map-modal button {
      margin-top: 10px;
      padding: 10px;
      background: #160063;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      width: 100%;
    }    
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-store"></i> 9000 shop</h1>
  </header>

  <div class="cart-container">
    {% for item in cart.items.all %}
    <div class="cart-item">
      <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}">
      <div class="cart-info">
        <div class="info-left">{{ item.product.title }}</div>
        <div class="info-center">{{ item.product.price|floatformat:0 }}</div>
        <div class="info-right cart-actions">
          <a href="{% url 'update_quantity' item.id 'minus' %}"><button>-</button></a>
          <span>{{ item.quantity }}</span>
          <a href="{% url 'update_quantity' item.id 'plus' %}"><button>+</button></a>
        </div>
      </div>
    </div>
    {% empty %}
    <p style="padding: 20px;text-align: center;">Savatcha bo‘sh</p>
    {% endfor %}
  </div>
  

    <div class="summary-box">
      <div class="left">
        <div><strong>Mahsulotlar soni:</strong> {{ cart.total_quantity }} ta</div>
        <div><strong>Komissiya:</strong> 0,00 so’m</div>
        <div><strong>Yetkazib berish:</strong> Bepul</div>
        <div><strong>Yetkazish vaqti:</strong> 1 kun</div>
      </div>
      <div class="right">
        <div>Jami summa:</div>
        <div style="font-size: 250%;">{{ cart.total_price|floatformat:0 }}</div>
      </div>
    </div>

    <div class="action-buttons">
      <button type="button" onclick="openModal()">Buyurtma berish</button>
    </div>
  </div>

  <div class="order-modal" id="orderModal">
    <div class="modal-content">
      <h3>Buyurtma ma'lumotlari</h3>
      <form method="post">
        {% csrf_token %}
  
        <label>Ism:</label>
        <input type="text" name="full_name" required>
  
        <label>Telefon raqami:</label>
        <input type="text" name="phone" required placeholder="+998901234567">
  
        <label>Manzilni belgilash:</label>
        <div class="address-group">
          <textarea name="address" id="address" rows="3" required></textarea>
          <div id="mapModal" class="map-modal">
            <div id="map" style="height: 400px;"></div>
            <button onclick="confirmLocation()">✅ Tanlash</button>
            <button onclick="closeMap()">❌ Yopish</button>
          </div>
          <button type="button" class="map-button" onclick="openMap()">
            <i class="fas fa-map-marker-alt"></i>
          </button>          
        </div>
        
        <!-- Latitude va Longitude saqlanadi -->
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
        
  
        <h3 style="margin-top: 10px;margin-bottom: 10px">To'lov usuli:</h3>
        <div class="payment-options">
          <label class="option-box">
            <input type="radio" name="payment_type" value="oldindan" required>
            💳 Bank kartasi (Humo, Uzcard)
          </label>
          <label class="option-box">
            <input type="radio" name="payment_type" value="olgandan" required>
            📦 Mahsulotni olganda
          </label>
        </div>
        <div id="cardDetails" style="display: none; background: #f8f8f8; border-radius: 10px; padding: 12px; margin-top: 10px;">
          <p><strong>💳:</strong> 
            <span id="cardNumber">8600 1234 5678 9012</span>
            <i class="fas fa-copy" onclick="copyToClipboard('cardNumber')" style="margin-left:8px; cursor:pointer; color: #160063;"></i>
          </p>
          <p><strong>Muhammadxonov Kamolxon</strong></p>
        </div>
        
  
        <div class="modal-buttons">
          <button type="button" onclick="closeModal()">Bekor qilish</button>
          <button type="submit">Yuborish</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Map Modal -->
  <div id="mapModal" class="map-modal">
    <div id="map" style="height: 400px;"></div>
    <button onclick="closeMapModal()">✅ Tanlandi</button>
  </div>
   
  

  <footer>
    <a href="/"><i class="fas fa-home"></i><span>Asosiy</span></a>
    <a href="/"><i class="fas fa-th-list"></i><span>Katalog</span></a>
    <a href="/free/"><i class="fas fa-gift"></i><span>Bepul</span></a>
    <a href="/cart/"><i class="fas fa-shopping-cart"></i><span>Savat</span></a>
  </footer>

  <script>
    const modal = document.getElementById("orderModal");
    function openModal() {
      modal.style.display = "flex";
    }
    function closeModal() {
      modal.style.display = "none";
    }
    {% if messages %}
      {% for message in messages %}
        alert("{{ message }}");
      {% endfor %}
    {% endif %}
  </script>
  <script>
    let map, marker, selectedLatLng;
    
    function openMap() {
      document.getElementById("mapModal").style.display = "flex";
    
      if (!map) {
        map = L.map("map").setView([41.3111, 69.2797], 13); // Tashkent
    
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap",
        }).addTo(map);
    
        map.on("click", function (e) {
          selectedLatLng = e.latlng;
          if (marker) {
            marker.setLatLng(e.latlng);
          } else {
            marker = L.marker(e.latlng).addTo(map);
          }
        });
    
        // Geolokatsiya
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            selectedLatLng = { lat, lng };
            map.setView([lat, lng], 15);
            marker = L.marker([lat, lng]).addTo(map);
          });
        }
      }
    }
    
    function closeMap() {
      document.getElementById("mapModal").style.display = "none";
    }
    
    function confirmLocation() {
      if (!selectedLatLng) return alert("Joy tanlanmagan");
    
      const lat = selectedLatLng.lat;
      const lon = selectedLatLng.lng;
    
      fetch(`/api/reverse/?lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("address").value = data.address || "Manzil topilmadi";
          closeMap();
        })
        .catch(err => {
          alert("Manzil aniqlanmadi");
          closeMap();
        });
    }
  </script>  
  <script>
    const cardDetails = document.getElementById("cardDetails");
    const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
  
    paymentRadios.forEach(radio => {
      radio.addEventListener("change", function() {
        if (this.value === "oldindan") {
          cardDetails.style.display = "block";
        } else {
          cardDetails.style.display = "none";
        }
      });
    });
  
    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("Karta raqami nusxalandi");
      }).catch(err => {
        alert("Nusxalab bo‘lmadi");
      });
    }
  </script>
    
  
    
  
</body>
</html>
